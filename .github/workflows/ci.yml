name: CI

on:
  pull_request:
    branches:
      - main
      - release

jobs:
  branch-naming:
    name: Validate branch name
    runs-on: ubuntu-latest
    steps:
      - name: Check branch name format
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Checking branch name: $BRANCH"

          # Must start with a valid prefix
          if [[ ! "$BRANCH" =~ ^(feature|bugfix|hotfix|chore|docs|refactor|test)/ ]]; then
            echo "::error::Branch name must start with a valid prefix (feature/, bugfix/, hotfix/, chore/, docs/, refactor/, test/)"
            exit 1
          fi

          # After prefix, must be lowercase kebab-case
          SUFFIX="${BRANCH#*/}"
          if [[ ! "$SUFFIX" =~ ^[a-z0-9]+(-[a-z0-9]+)*$ ]]; then
            echo "::error::Branch name after prefix must be lowercase kebab-case (e.g., feature/my-new-feature)"
            exit 1
          fi

          echo "Branch name is valid."

  format:
    name: Check formatting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check formatting
        run: npm run format:check

  test:
    name: Run tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-build
          path: |
            dist/
            manifest.json
            popup/
            icons/
